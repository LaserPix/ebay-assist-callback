<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>eBay Assist Authorization</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; text-align: center; padding-top: 5em; background-color: #f5f5f5; color: #333; }
        .container { max-width: 600px; margin: auto; padding: 2em; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        a { color: #0060e0; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Authorization Received</h1>
        <p>You can now return to the eBay Assist application. It is safe to close this browser tab.</p>
        <p><a id="redirect-link" href="#">Click here if you are not redirected automatically.</a></p>
    </div>

    <script>
        (function() {
            // eBay's auth code can contain a '#' which breaks standard URL parsing.
            // We must manually reconstruct the URL by looking at both the search and hash parts.
            const searchParams = new URLSearchParams(window.location.search);
            const hashString = window.location.hash.substring(1); // Remove the leading '#'

            const code = searchParams.get('code');
            let state = searchParams.get('state');
            
            // If the state is not in the search part, it's because the '#' in the code broke it.
            // In that case, the state will be in the hash part.
            if (!state) {
                const hashParams = new URLSearchParams(hashString);
                state = hashParams.get('state');
            }

            if (code && state) {
                // Reconstruct the full, but now correctly parsable, redirect URL.
                // We encode the problematic hash from the code to prevent it from breaking our own URL.
                const fullCode = code + (hashString.split('&')[0] ? '#' + hashString.split('&')[0] : '');
                const redirectUrl = `ebay-assist://oauth-callback?code=${encodeURIComponent(fullCode)}&state=${state}`;

                document.getElementById('redirect-link').href = redirectUrl;
                window.location.replace(redirectUrl);
            } else {
                const error = searchParams.get('error');
                const errorDescription = searchParams.get('error_description');
                if (error) {
                    const redirectUrl = `ebay-assist://oauth-callback?error=${error}&error_description=${errorDescription}&state=${state}`;
                    document.getElementById('redirect-link').href = redirectUrl;
                    window.location.replace(redirectUrl);
                }
            }
        })();
    </script>

</body>
</html>
